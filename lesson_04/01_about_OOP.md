# 並列処理基礎
並列処理とは、読んで字のごとく、処理を並列化させることを指します。
人で例えると、本を読みながら、テレビを流し見しつつ、メールを書く……。
簡単シンプルのようでいて、処理速度向上にとてつもない力を発揮します。

これをより具体的に理解するため、ハードウェアの仕様を見て参りましょう。

## ハードウェアにとっての並列処理
コンピュータ、パソコンは何でも出来る万能な機械かに思われます。
youtube を見ながら、Excel で表を作成し、ブラウザで観光地情報を検索する。
このように複数のタスクを実行することを マルチタスク と言います。

コンピュータは人間よりも、よほど並列処理が得意そうに思えます。

果たしてそうでしょうか？

### 疑似マルチタスク
コンピュータの頭脳といえば、CPU ですが、CPU は実はシングルタスクしか扱えません。
では、どのようにしてマルチタスクを実現しているかといえば、素早く複数のタスクを繰り返し実行する。
人間で例えると、、、

1. 10秒本を読む
2. 10秒テレビを見る
3. 10秒疑メールを書く

これを ミリ秒単位で高速で切り替えているのがコンピュータ。
これは疑似マルチタスクとも言われます。

### 本当のマルチタスク
CPU はシングルタスクと伝えた通りですが、シングルタスクにも限界があります。
シンプルな処理だけならシングルタスクで十分なのですが、
昨今のような高画質の動画再生や、3D の描画、高機能のアプリケーションの複数立ち上げ……。
このようなコストの高い処理で擬似マルチタスクを行うとタイムラグが発生しやすくなる等悪影響が出始めます。

そこで登場したのが、マルチコアCPU と、マルチコア対応OS による、より最適化されたマルチタスク処理です。

重い処理、もしくはいま現在活性化している処理に対して、CPUの割当を行いやすくなりました。

### ハードウェアにとっての並列処理 まとめ
上記の通り、コンピュータは マルチコアCPU によるマルチタスク処理が行われ、またより具体的にはそれぞれの CPU 上で擬似マルチタスク処理が行われています。
CPU の仕様は、基本的に一つの CPU に対して命令し、その CPU 負荷が高まった際に、別の CPU に対して命令が行われる、もしくは、より優先度の高い処理に対して負荷の低い CPU が割り当てられるといったものです。

さて、話を戻しましょう。
ハードウェアにとっての並列処理では複数の CPU に対して明示的に並列で処理を命令することを指します。
特にサーバ機で利用される 8コア以上の CPU で威力を発揮し、コア数が大きいほど並列処理の効果が高まります。

## ソフトウェアにとっての並列処理
ハードウェアの仕様はわかりました。
では、ソフトウェアの仕様、並列処理プログラミング についてみていきましょう

### ソフトウェア と CPU
ソフトウェアは実行されると タスクとしてCPUが管理を行います。
そのタスクは、1つ以上のプロセスにより構成され、プロセスは幾つかのスレッドにより構成されます。

プロセスが具体的な処理で、スレッドは CPU に対する命令。
タスクはプロセスを纏めた物と認識すれば大凡間違いはないかと思われます。

### スレッドの概念
スレッドは CPU に対する命令でした。
基本的なプログラミングでは、スレッドは単一になり、
上から順に処理を逐次実行していくことを表します。
これをシングルスレッドと呼びます。

対してマルチスレッドとは、複数のスレッドが並列して実行されることを指します。そうです。ソフトウェアの並列処理とはマルチスレッドを利用した処理を書くことだと言えます。

### マルチスレッド詳細
マルチスレッドによる、処理は言語を問わず、活用される機会が増えてきました。

Javascript では非同期処理を書くことが多いですが、Javascript 自体はシングルスレッドで実装されており、非同期処理と、並列処理は別なので注意が必要です。
とは言え、実行順序が同期されないという点において共通するので例として Javascript の非同期処理の例を見てみます。

~~~javascript
doAsync = (name, time) => {
    for (let i = 0; i <= 10; i++) {
        setTimeout(() => console.log('thread: ' + name + ', loop: ' + i), time * i);
    }
}

doAsync('p1', 100)
doAsync('p2', 200)
doAsync('p3', 300)
~~~

### レッスン マルチスレッド処理を書く
例として、シングルスレッド、マルチスレッドの処理を書いて実行してみましょう


### マルチスレッド注意事項
マルチスレッドの場合、スレッドセーフな処理かどうか？という点が大事になってきます。
例えば、シングルトンパターンの実装について、スレッドセーフにしないと、場合によってはインスタンスの単一性が保証されないことがあります。

- [シングルトンパターン 例](https://qiita.com/shoheiyokoyama/items/c16fd547a77773c0ccc1)

### ソフトウェアにとっての並列処理 まとめ
並列処理を行うためには、それ用の書き方があります。
それらを実際に使いながら学習することが上達のポイントです。

## 並列処理基礎 まとめ
難しいようでいて、概要だけみると以外に簡単な気がしませんか？
実際に使うとハマりどころもありますが、とにかく強力なのが並列処理。
9時間掛かったバッチ処理が20分に……！
ということも実際に経験しました。

この機会に並列処理がより身近になりましたら幸いです。
